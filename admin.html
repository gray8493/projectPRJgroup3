<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Menu - Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <div class="admin-header">
        <h1><i class="fas fa-cog"></i> Quản lý Menu - Admin</h1>
        <div class="user-info">
            <span id="user-name">Admin</span>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </button>
        </div>
    </div>

    <div class="admin-container">
        <div class="management">
            <h3>Quản lý menu</h3>
            <form id="menu-form">
                <input type="hidden" id="menu-id">
                <div class="form-grid">
                    <input id="menu-name" type="text" placeholder="Tên món" required>
                    <input id="menu-price" type="number" min="0" step="1000" placeholder="Giá (VND)" required>
                    <select id="menu-category" required>
                        <option value="">-- Chọn loại --</option>
                        <option value="coffee">Cà phê</option>
                        <option value="tea">Trà</option>
                        <option value="juice">Nước ép</option>
                        <option value="smoothie">Sinh tố</option>
                        <option value="snack">Món ăn vặt</option>
                    </select>
                    <button type="submit" class="btn primary" id="menu-save-btn">Lưu</button>
                    <button type="button" class="btn secondary" id="menu-reset-btn">Hủy</button>
                </div>
            </form>
            
            <div class="category-tabs">
                <button class="category-tab active" data-category="coffee">Cà phê</button>
                <button class="category-tab" data-category="tea">Trà</button>
                <button class="category-tab" data-category="juice">Nước ép</button>
                <button class="category-tab" data-category="smoothie">Sinh tố</button>
                <button class="category-tab" data-category="snack">Món ăn vặt</button>
            </div>
            
            <div id="menu-list" class="menu-list"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentCategory = 'coffee';
        let currentUser = null;

        // Check authentication
        function checkAuth() {
            const user = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (!user || !token) {
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = JSON.parse(user);
            
            // Check if user is admin
            if (currentUser.role !== 'admin') {
                alert('Bạn không có quyền truy cập trang này');
                window.location.href = 'order.html';
                return;
            }
            
            document.getElementById('user-name').textContent = currentUser.name || currentUser.username;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // Initialize the application
        async function init() {
            checkAuth();
            await renderMenuList(currentCategory);
            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', async (e) => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    currentCategory = e.target.dataset.category;
                    await renderMenuList(currentCategory);
                });
            });

            // Management handlers
            setupManagement();
        }

        // Load menu items
        async function fetchMenu(category) {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/menu?category=${encodeURIComponent(category)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!res.ok) {
                    if (res.status === 401) {
                        logout();
                        return [];
                    }
                    console.error('API Error:', res.status, res.statusText);
                    return [];
                }
                const data = await res.json();
                return Array.isArray(data) ? data : [];
            } catch (e) {
                console.error('API Error:', e);
                return [];
            }
        }

        // Render menu list
        async function renderMenuList(category) {
            const list = document.getElementById('menu-list');
            if (!list) return;
            list.innerHTML = '';
            const items = await fetchMenu(category);
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'menu-item-row';
                row.innerHTML = `
                    <div class="menu-item-info">
                        <h4>${item.name}</h4>
                        <p>${formatPrice(item.price)} · ${item.category}</p>
                    </div>
                    <div class="menu-actions">
                        <button class="btn primary" data-edit="${item.id}">Sửa</button>
                        <button class="btn danger" data-del="${item.id}">Xóa</button>
                    </div>
                `;
                const editBtn = row.querySelector('[data-edit]');
                const delBtn = row.querySelector('[data-del]');
                if (editBtn) editBtn.addEventListener('click', () => fillForm(item));
                if (delBtn) delBtn.addEventListener('click', () => deleteMenuItem(item.id));
                list.appendChild(row);
            });
        }

        // Fill form with item data
        function fillForm(item) {
            document.getElementById('menu-id').value = item.id || '';
            document.getElementById('menu-name').value = item.name || '';
            document.getElementById('menu-price').value = item.price || '';
            document.getElementById('menu-category').value = item.category || currentCategory;
        }

        // Reset form
        function resetForm() {
            document.getElementById('menu-id').value = '';
            document.getElementById('menu-name').value = '';
            document.getElementById('menu-price').value = '';
            document.getElementById('menu-category').value = '';
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        // Create menu item
        async function createMenuItem(payload) {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_BASE}/menu`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                if (res.status === 401) {
                    logout();
                    return;
                }
                throw new Error(await res.text());
            }
            return await res.json();
        }

        // Update menu item
        async function updateMenuItem(id, payload) {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_BASE}/menu/${encodeURIComponent(id)}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                if (res.status === 401) {
                    logout();
                    return;
                }
                throw new Error(await res.text());
            }
            return await res.json();
        }

        // Delete menu item
        async function deleteMenuItem(id) {
            if (!confirm('Xóa món này?')) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_BASE}/menu/${encodeURIComponent(id)}`, { 
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!res.ok && res.status !== 204) { 
                if (res.status === 401) {
                    logout();
                    return;
                }
                alert('Xóa thất bại: ' + (await res.text())); 
                return; 
            }
            await renderMenuList(currentCategory);
        }

        // Setup management form
        function setupManagement() {
            const form = document.getElementById('menu-form');
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('menu-id').value;
                const name = document.getElementById('menu-name').value.trim();
                const price = parseInt(document.getElementById('menu-price').value, 10) || 0;
                const category = document.getElementById('menu-category').value || currentCategory;
                if (!name || !category) return;
                try {
                    if (id) {
                        await updateMenuItem(id, { name, price, category });
                    } else {
                        await createMenuItem({ name, price, category });
                    }
                    resetForm();
                    await renderMenuList(currentCategory);
                } catch (err) {
                    alert('Lưu thất bại: ' + err);
                }
            });

            const resetBtn = document.getElementById('menu-reset-btn');
            if (resetBtn) resetBtn.addEventListener('click', (e) => { e.preventDefault(); resetForm(); });
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
