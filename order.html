<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt hàng - Hệ thống POS Cafe</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <div class="order-header">
        <h1><i class="fas fa-coffee"></i> Hệ thống đặt đồ uống</h1>
        <div class="user-info">
            <span id="user-name">Nhân viên</span>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </button>
        </div>
    </div>

    <div class="order-container">
        <div class="order-sidebar">
            <!-- Loại đơn hàng -->
            <div class="order-type">
                <h3>Loại đơn hàng</h3>
                <div class="order-buttons">
                    <button class="order-btn active" data-type="dine-in">
                        <i class="fas fa-utensils"></i> Tại chỗ
                    </button>
                    <button class="order-btn" data-type="takeaway">
                        <i class="fas fa-shopping-bag"></i> Mang về
                    </button>
                    <button class="order-btn" data-type="delivery">
                        <i class="fas fa-motorcycle"></i> Giao hàng
                    </button>
                </div>
            </div>

            <!-- Chọn bàn (chỉ hiện khi chọn tại chỗ) -->
            <div class="table-selection" id="table-selection">
                <h3>Chọn bàn</h3>
                <div class="table-grid" id="table-grid">
                    <!-- Tables will be generated by JavaScript -->
                </div>
            </div>

            <!-- Giỏ hàng -->
            <div class="cart">
                <h3>Đơn hàng <span id="cart-count">(0)</span></h3>
                <div id="cart-items"></div>
                
                <div class="checkout-section">
                    <div class="total-amount">
                        Tổng: <span id="total-amount">0₫</span>
                    </div>
                    <button class="checkout-btn" onclick="checkout()">
                        <i class="fas fa-cash-register"></i> Thanh toán
                    </button>
                </div>
            </div>
        </div>

        <div class="order-main-content">
            <!-- Category tabs -->
            <div class="category-tabs">
                <button class="category-tab active" data-category="coffee">Cà phê</button>
                <button class="category-tab" data-category="tea">Trà</button>
                <button class="category-tab" data-category="juice">Nước ép</button>
                <button class="category-tab" data-category="smoothie">Sinh tố</button>
                <button class="category-tab" data-category="snack">Món ăn vặt</button>
            </div>

            <!-- Products grid -->
            <div class="products-grid" id="products-grid">
                <!-- Products will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Modal thanh toán -->
    <div id="checkout-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="success-message">
                <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 20px; color: #28a745;"></i>
                <h2>Đặt hàng thành công!</h2>
                <p>Cảm ơn bạn đã đặt hàng. Đơn hàng của bạn đang được xử lý.</p>
                <div id="order-summary" style="margin-top: 20px; text-align: left;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        let cart = [];
        let currentOrderType = 'dine-in';
        let selectedTable = null;
        let currentCategory = 'coffee';
        let currentUser = null;

        // Check authentication
        function checkAuth() {
            const user = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (!user || !token) {
                window.location.href = 'login.html';
                return;
            }
            
            currentUser = JSON.parse(user);
            document.getElementById('user-name').textContent = currentUser.name || currentUser.username;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // Initialize the application
        async function init() {
            checkAuth();
            updateTime();
            setInterval(updateTime, 1000);
            generateTables();
            await loadProducts('coffee');
            setupEventListeners();
        }

        // Update current time
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN');
            // Time display can be added if needed
        }

        // Generate table buttons
        function generateTables() {
            const tableGrid = document.getElementById('table-grid');
            tableGrid.innerHTML = '';
            
            for (let i = 1; i <= 12; i++) {
                const tableBtn = document.createElement('button');
                tableBtn.className = 'table-btn';
                tableBtn.textContent = `Bàn ${i}`;
                tableBtn.onclick = () => selectTable(i);
                tableGrid.appendChild(tableBtn);
            }
        }

        // Select table
        function selectTable(tableNumber) {
            const tables = document.querySelectorAll('.table-btn');
            tables.forEach(table => table.classList.remove('selected'));
            
            event.target.classList.add('selected');
            selectedTable = tableNumber;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Order type buttons
            document.querySelectorAll('.order-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.order-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentOrderType = e.target.dataset.type;
                    
                    // Show/hide table selection
                    const tableSelection = document.getElementById('table-selection');
                    if (currentOrderType === 'dine-in') {
                        tableSelection.classList.remove('hidden');
                    } else {
                        tableSelection.classList.add('hidden');
                        selectedTable = null;
                    }
                });
            });

            // Category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', async (e) => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    currentCategory = e.target.dataset.category;
                    await loadProducts(currentCategory);
                });
            });

            // Modal close
            document.querySelector('.close').addEventListener('click', () => {
                document.getElementById('checkout-modal').style.display = 'none';
            });

            window.addEventListener('click', (e) => {
                const modal = document.getElementById('checkout-modal');
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Load products by category
        async function loadProducts(category) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/menu?category=${encodeURIComponent(category)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!res.ok) {
                    if (res.status === 401) {
                        logout();
                        return;
                    }
                    console.error('API Error:', res.status, res.statusText);
                    return;
                }
                
                const items = await res.json();
                
                items.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.onclick = () => addToCart(product);

                    productCard.innerHTML = `
                        <div class="product-image">
                            <i class="fas fa-coffee"></i>
                        </div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatPrice(Number(product.price))}</div>
                    `;

                    grid.appendChild(productCard);
                });
            } catch (e) {
                console.error('API Error:', e);
            }
        }

        // Add item to cart
        function addToCart(product) {
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({...product, quantity: 1});
            }
            
            updateCartDisplay();
        }

        // Remove item from cart
        function removeFromCart(productId) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                cart.splice(itemIndex, 1);
                updateCartDisplay();
            }
        }

        // Update item quantity
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    updateCartDisplay();
                }
            }
        }

        // Update cart display
        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-count');
            const totalAmount = document.getElementById('total-amount');

            cartItems.innerHTML = '';
            let total = 0;
            let itemCount = 0;

            cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                itemCount += item.quantity;

                cartItem.innerHTML = `
                    <div>
                        <div style="font-weight: bold;">${item.name}</div>
                        <div style="color: #666; font-size: 12px;">${formatPrice(item.price)} x ${item.quantity}</div>
                    </div>
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                        <button class="qty-btn" onclick="removeFromCart(${item.id})" style="background: #dc3545; margin-left: 5px;">×</button>
                    </div>
                `;

                cartItems.appendChild(cartItem);
            });

            cartCount.textContent = `(${itemCount})`;
            totalAmount.textContent = formatPrice(total);
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        // Checkout function
        function checkout() {
            if (cart.length === 0) {
                alert('Vui lòng chọn ít nhất một món!');
                return;
            }

            if (currentOrderType === 'dine-in' && !selectedTable) {
                alert('Vui lòng chọn bàn!');
                return;
            }

            // Create order summary
            let orderSummary = `
                <h3>Chi tiết đơn hàng:</h3>
                <p><strong>Loại đơn:</strong> ${getOrderTypeName(currentOrderType)}</p>
            `;

            if (currentOrderType === 'dine-in') {
                orderSummary += `<p><strong>Bàn:</strong> ${selectedTable}</p>`;
            }

            orderSummary += '<h4>Món đã đặt:</h4><ul>';
            let total = 0;

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                orderSummary += `<li>${item.name} x${item.quantity} - ${formatPrice(itemTotal)}</li>`;
            });

            orderSummary += `</ul><h4>Tổng cộng: ${formatPrice(total)}</h4>`;

            document.getElementById('order-summary').innerHTML = orderSummary;
            document.getElementById('checkout-modal').style.display = 'block';

            // Save order to localStorage (in real app, send to server)
            const order = {
                id: Date.now(),
                type: currentOrderType,
                table: selectedTable,
                items: [...cart],
                total: total,
                timestamp: new Date().toISOString(),
                staff: currentUser.username
            };

            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Clear cart
            cart = [];
            selectedTable = null;
            updateCartDisplay();
            
            // Reset selections
            document.querySelectorAll('.table-btn').forEach(btn => btn.classList.remove('selected'));
        }

        // Get order type name in Vietnamese
        function getOrderTypeName(type) {
            switch(type) {
                case 'dine-in': return 'Tại chỗ';
                case 'takeaway': return 'Mang về';
                case 'delivery': return 'Giao hàng';
                default: return type;
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
