<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Coffee Order System - Updated 21:58</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }
        .text-shadow-custom {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .btn-primary {
            transition: all 0.2s;
            @apply bg-green-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-green-700 active:scale-95;
        }
        .btn-secondary {
            transition: all 0.2s;
            @apply bg-blue-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-blue-700 active:scale-95;
        }
        .order-btn {
            transition: all 0.2s;
            @apply bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-amber-600 active:scale-95 text-sm;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Global Container -->
    <div id="app-container" class="w-full max-w-7xl bg-white rounded-2xl shadow-2xl p-6 transition-all duration-300">

        <!-- Header (Visible on all pages except Customer View) -->
        <header id="app-header" class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
            <h1 class="text-3xl font-extrabold text-amber-700 flex items-center">
                ☕ Coffee Nexus
                <span id="current-user-info" class="ml-4 text-sm font-medium text-gray-500"></span>
            </h1>
            <div class="flex gap-3">
                <button class="btn-secondary" onclick="goBackToAdmin()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="inline mr-2" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                    </svg>
                    Quay lại Admin
                </button>
                <button id="logout-button" class="btn-secondary hidden" onclick="logout()">Logout</button>
            </div>
        </header>

        

        <!-- 2. Staff Order Menu Page -->
        <div id="page-staff-order" class="page hidden">
            <div class="grid lg:grid-cols-3 gap-6">

                <!-- Left Column: Menu Items -->
                <div class="lg:col-span-2 space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Menu Selection</h2>
                    <!-- Order Type Selector -->
                    <div id="order-type-selector" class="flex flex-wrap gap-3 p-4 rounded-xl bg-gray-50 border">
                        <label class="font-medium text-gray-700 mr-2">Order Type:</label>
                        <button class="order-btn" onclick="updateOrderType('Dine In', 1)">Dine In</button>
                        <button class="order-btn" onclick="updateOrderType('Take Away')">Take Away</button>
                        <button class="order-btn" onclick="updateOrderType('Delivery')">Delivery</button>
                        <select id="table-select" class="p-2 border rounded-lg text-sm bg-white" onchange="updateTableNumber(this.value)">
                            <option value="">Table</option>
                            <!-- Options 1-12 added by JS -->
                        </select>
                    </div>

                    <!-- Menu Grid -->
                    <div id="menu-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Menu items will be rendered here -->
                    </div>
                </div>

                <!-- Right Column: Current Order Summary -->
                <div class="lg:col-span-1 space-y-4 p-4 rounded-2xl shadow-xl bg-amber-50 border-amber-200 border">
                    <h2 class="text-2xl font-bold text-amber-800">Current Order</h2>
                    <div id="current-order-meta" class="text-sm space-y-1 pb-3 border-b">
                        <p>Type: <span id="meta-type" class="font-semibold">N/A</span></p>
                        <p>Table: <span id="meta-table" class="font-semibold">N/A</span></p>
                        <p>Items: <span id="meta-items" class="font-semibold">0</span></p>
                    </div>

                    <div id="order-items-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                        <!-- Ordered items will appear here -->
                        <p class="text-gray-500 italic" id="empty-order-message">Add items to start the order.</p>
                    </div>

                    <div class="pt-4 border-t border-amber-300 space-y-2">
                        <p class="text-xl font-bold text-gray-800">Total Amount:</p>
                        <p class="text-4xl font-extrabold text-green-600">
                            $<span id="total-amount">0.00</span>
                        </p>
                        <button class="btn-primary w-full mt-4" onclick="checkoutOrder()">
                            Process Payment
                        </button>
                        <button class="btn-secondary w-full" onclick="toggleCustomerView(true)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="inline mr-2" viewBox="0 0 16 16">
                                <path d="M4.5 1.5A.5.5 0 0 0 4 2v12a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V2a.5.5 0 0 0-.5-.5h-7ZM5 2.5h6V13.5H5z"/>
                            </svg>
                            Show Customer Display
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Admin Page -->
       

    <!-- Customer Display Overlay (Simulated Second Screen) -->
    <div id="page-customer-view" class="fixed inset-0 bg-gray-900 bg-opacity-95 hidden z-50 p-8 flex flex-col justify-between" onclick="toggleCustomerView(false)">
        <div class="text-center text-white">
            <h1 class="text-6xl font-black text-amber-400 text-shadow-custom mb-4">Your Order Summary</h1>
            <p id="customer-view-meta" class="text-2xl font-light text-gray-300">Order Type: <span class="font-semibold text-white" id="customer-meta-type">N/A</span> | Table: <span class="font-semibold text-white" id="customer-meta-table">N/A</span></p>
        </div>

        <div id="customer-view-items" class="max-w-4xl mx-auto w-full space-y-4 my-8 p-6 bg-white/10 rounded-3xl glass-card max-h-[60vh] overflow-y-auto">
            <!-- Customer items will appear here -->
        </div>

        <div class="text-center">
            <p class="text-4xl font-bold text-gray-200">Total Items: <span id="customer-total-items" class="text-amber-300">0</span></p>
            <p class="text-8xl font-black text-green-400 mt-4 text-shadow-custom">
                TOTAL: $<span id="customer-total-amount">0.00</span>
            </p>
            <button class="text-white mt-8 text-xl opacity-70 hover:opacity-100 transition" >
                Tap anywhere to close the display
            </button>
        </div>
    </div>

    <!-- Customization Modal -->
    <div id="customization-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl space-y-4">
            <h3 class="text-xl font-bold text-amber-700">Customize Order</h3>
            <p id="modal-item-name" class="text-lg font-semibold"></p>
            <div class="space-y-3">
                <label for="flavour-select" class="block text-sm font-medium text-gray-700">Choose Flavor:</label>
                <select id="flavour-select" class="w-full p-2 border rounded-lg">
                    <option value="Standard">Standard</option>
                    <option value="Vanilla Syrup (+0.50)">Vanilla Syrup (+$0.50)</option>
                    <option value="Caramel Shot (+0.50)">Caramel Shot (+$0.50)</option>
                    <option value="Hazelnut">Hazelnut</option>
                </select>
                <label for="temperature-select" class="block text-sm font-medium text-gray-700">Temperature:</label>
                <select id="temperature-select" class="w-full p-2 border rounded-lg">
                    <option value="Hot">Hot</option>
                    <option value="Iced">Iced</option>
                    <option value="Blended (+1.00)">Blended (+$1.00)</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button class="py-2 px-4 rounded-xl text-gray-700 border hover:bg-gray-100" onclick="closeModal()">Cancel</button>
                <button id="add-to-order-btn" class="btn-primary" onclick="confirmCustomization()">Add to Order</button>
            </div>
        </div>
    </div>


<script>
    // --- Global Variables ---
    let MENU_ITEMS = []; // Will be populated from MySQL database
    let currentOrder = {
        items: [],
        totalItems: 0,
        totalAmount: 0.00,
        type: 'Dine In',
        tableNumber: 1
    };
    let itemToCustomize = null;

    
    // --- API Functions ---
    
    /**
     * Fetches menu items from the MySQL database via REST API
     */
    async function fetchMenuItems() {
        try {
            const response = await fetch('/api/coffees');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            MENU_ITEMS = data.filter(item => item.available); // Only show available items
            renderMenu();
        } catch (error) {
            console.error('Error fetching menu items:', error);
            showErrorMessage('Failed to load menu items from database. Please refresh the page.');
            MENU_ITEMS = [];
        }
    }

    /**
     * Shows error message to user
     */
    function showErrorMessage(message) {
        // Create a simple error notification
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50';
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }

    /**
     * Process payment for current order
     */
    function checkoutOrder() {
        if (currentOrder.items.length === 0) {
            alert('Please add items to your order before checkout.');
            return;
        }
        
        if (currentOrder.type === 'Dine In' && !currentOrder.tableNumber) {
            alert('Please select a table for dine-in orders.');
            return;
        }
        
        // Here you would integrate with payment system
        const confirmed = confirm(`Process payment of $${currentOrder.totalAmount.toFixed(2)}?`);
        if (confirmed) {
            alert('Payment processed successfully! Order has been sent to kitchen.');
            // Reset order
            currentOrder.items = [];
            renderOrderSummary();
        }
    }

    // --- Utility Functions ---

    /**
     * Escapes HTML to prevent XSS attacks
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Finds the base price from the customization string, e.g., "(+0.50)"
     * @param {string} customization - The customization option string.
     * @returns {number} Extra cost.
     */

    function getCustomizationCost(customization) {
        const match = customization.match(/\(\+(\d+\.?\d*)\)/);
        return match ? parseFloat(match[1]) : 0;
    }

    // --- Rendering Functions ---

    /**
     * Renders the menu grid on the Staff Order page.
     */
    function renderMenu() {
        const menuGrid = document.getElementById('menu-grid');
        if (!menuGrid) return;

        menuGrid.innerHTML = '';

        if (!MENU_ITEMS.length) {
            menuGrid.innerHTML = `
                <div class="col-span-full text-center p-6 rounded-xl bg-gray-50 border">
                    <p class="text-gray-500">No menu items available. Please add data to MySQL database.</p>
                </div>
            `;
            return;
        }

        MENU_ITEMS.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'p-4 rounded-xl bg-gray-50 border border-gray-200 shadow hover:shadow-md transition duration-200 space-y-2';
            itemElement.innerHTML = `
                <h4 class="font-bold text-lg text-gray-800">${escapeHtml(item.name)}</h4>
                <p class="text-amber-600 font-semibold">$${item.price.toFixed(2)}</p>
                <p class="text-sm text-gray-500">${escapeHtml(item.category || 'Coffee')}</p>
                ${item.description ? `<p class="text-xs text-gray-400">${escapeHtml(item.description)}</p>` : ''}
                <button class="order-btn w-full mt-2" ${item.available ? '' : 'disabled'} 
                        onclick="openCustomizationModal(${item.id})">
                    ${item.available ? 'Select' : 'Unavailable'}
                </button>
            `;
            menuGrid.appendChild(itemElement);
        });
    }

    /**
     * Calculates the order totals.
     */
    function calculateTotals() {
        let totalItems = 0;
        let totalAmount = 0;
        
        currentOrder.items.forEach(item => {
            totalItems += item.quantity;
            totalAmount += item.subtotal;
        });
        
        currentOrder.totalItems = totalItems;
        currentOrder.totalAmount = parseFloat(totalAmount.toFixed(2));
    }

    /**
     * Updates order meta information in the UI
     */
    function updateOrderMeta() {
        const tableText = currentOrder.type === 'Dine In' ? `Table ${currentOrder.tableNumber}` : 'N/A';
        
        // Update staff view
        document.getElementById('meta-type').textContent = currentOrder.type;
        document.getElementById('meta-table').textContent = tableText;
        document.getElementById('meta-items').textContent = currentOrder.totalItems;
        document.getElementById('total-amount').textContent = currentOrder.totalAmount.toFixed(2);

        // Update customer view
        document.getElementById('customer-meta-type').textContent = currentOrder.type;
        document.getElementById('customer-meta-table').textContent = tableText;
        document.getElementById('customer-total-items').textContent = currentOrder.totalItems;
        document.getElementById('customer-total-amount').textContent = currentOrder.totalAmount.toFixed(2);
    }

    /**
     * Renders the order summary for both staff and customer views
     */
    function renderOrderSummary() {
        calculateTotals();
        updateOrderMeta();
        
        const listContainer = document.getElementById('order-items-list');
        const customerListContainer = document.getElementById('customer-view-items');
        const emptyMessageElement = document.getElementById('empty-order-message');

        // Clear existing content
        listContainer.innerHTML = '';
        customerListContainer.innerHTML = '';

        // Handle empty order
        if (currentOrder.items.length === 0) {
            if (emptyMessageElement) emptyMessageElement.classList.remove('hidden');
            customerListContainer.innerHTML = '<p class="text-2xl text-center text-white/50 py-12">Waiting for staff to add items...</p>';
            return;
        }
        
        if (emptyMessageElement) emptyMessageElement.classList.add('hidden');

        // Render order items
        currentOrder.items.forEach((item, idx) => {
            // Create staff view item
            const staffItem = document.createElement('div');
            staffItem.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow-sm text-sm';
            staffItem.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${item.quantity}x ${escapeHtml(item.name)}</p>
                    <p class="text-xs text-gray-500">${escapeHtml(item.customization)}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-bold text-green-600">$${item.subtotal.toFixed(2)}</span>
                    <button class="text-red-500 hover:text-red-700" onclick="removeItemFromOrder(${idx})" aria-label="Remove item">✕</button>
                </div>
            `;
            listContainer.appendChild(staffItem);

            // Create customer view item
            const customerItem = document.createElement('div');
            customerItem.className = 'flex justify-between items-center p-4 bg-white/5 rounded-2xl border-b border-white/20 hover:bg-white/10 transition';
            customerItem.innerHTML = `
                <div class="flex-1">
                    <p class="text-2xl font-bold text-white">${escapeHtml(item.name)} x${item.quantity}</p>
                    <p class="text-base text-gray-300 italic">${escapeHtml(item.customization)}</p>
                </div>
                <span class="text-3xl font-extrabold text-amber-300">$${item.subtotal.toFixed(2)}</span>
            `;
            customerListContainer.appendChild(customerItem);
        });
    }

    /**
     * Initialize table selector dropdown with options 1-12
     */
    function initTableSelector() {
        const select = document.getElementById('table-select');
        for (let i = 1; i <= 12; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Table ${i}`;
            select.appendChild(option);
        }
        select.value = currentOrder.tableNumber;
    }

    // --- Modal Functions ---

    /**
     * Opens customization modal for selected item
     */
    function openCustomizationModal(itemId) {
        itemToCustomize = MENU_ITEMS.find(item => item.id === itemId);
        if (!itemToCustomize) return;
        
        document.getElementById('modal-item-name').textContent = itemToCustomize.name;
        document.getElementById('customization-modal').classList.remove('hidden');
        document.getElementById('flavour-select').value = 'Standard';
        document.getElementById('temperature-select').value = 'Hot';
    }

    /**
     * Confirms customization and adds item to order
     */
    function confirmCustomization() {
        const flavour = document.getElementById('flavour-select').value;
        const temperature = document.getElementById('temperature-select').value;
        const customizationString = `${flavour}, ${temperature}`;

        let basePrice = itemToCustomize.price;
        basePrice += getCustomizationCost(flavour);
        basePrice += getCustomizationCost(temperature);

        const newItem = {
            id: itemToCustomize.id,
            name: itemToCustomize.name,
            price: itemToCustomize.price,
            quantity: 1,
            customization: customizationString,
            subtotal: basePrice
        };

        // Check if item with same customization already exists
        const existingItemIndex = currentOrder.items.findIndex(
            item => item.id === newItem.id && item.customization === newItem.customization
        );
        
        if (existingItemIndex > -1) {
            // Update existing item
            currentOrder.items[existingItemIndex].quantity += 1;
            currentOrder.items[existingItemIndex].subtotal += basePrice;
        } else {
            // Add new item
            currentOrder.items.push(newItem);
        }

        closeModal();
        renderOrderSummary();
    }

    /**
     * Closes customization modal
     */
    function closeModal() {
        document.getElementById('customization-modal').classList.add('hidden');
        itemToCustomize = null;
    }

    /**
     * Removes or decreases quantity of item from order
     */
    function removeItemFromOrder(index) {
        const item = currentOrder.items[index];
        
        if (item.quantity > 1) {
            const unitPrice = item.subtotal / item.quantity;
            item.quantity -= 1;
            item.subtotal -= unitPrice;
        } else {
            currentOrder.items.splice(index, 1);
        }
        
        renderOrderSummary();
    }

    // --- Order Management Functions ---

    /**
     * Updates the order type and handles table selection
     */
    function updateOrderType(type, defaultTable = null) {
        currentOrder.type = type;
        
        // Handle table selection based on order type
        if (type !== 'Dine In') {
            currentOrder.tableNumber = null;
            document.getElementById('table-select').value = '';
        } else if (defaultTable) {
            currentOrder.tableNumber = defaultTable;
            document.getElementById('table-select').value = defaultTable;
        }
        
        // Update button styles
        const buttons = document.querySelectorAll('#order-type-selector button');
        buttons.forEach(button => {
            button.classList.remove('bg-red-500', 'hover:bg-red-600');
            if (button.textContent.trim().toLowerCase() === type.toLowerCase()) {
                button.classList.add('bg-red-500', 'hover:bg-red-600');
            }
        });
        
        renderOrderSummary();
    }

    /**
     * Updates the table number for dine-in orders
     */
    function updateTableNumber(table) {
        if (currentOrder.type === 'Dine In' && table) {
            currentOrder.tableNumber = parseInt(table);
        } else if (currentOrder.type === 'Dine In' && !table) {
            currentOrder.tableNumber = null;
        }
        renderOrderSummary();
    }

    /**
     * Toggles customer display view
     */
    function toggleCustomerView(show) {
        document.getElementById('page-customer-view').classList.toggle('hidden', !show);
    }

    // --- Authentication Functions ---
    
    /**
     * Check user authentication and role
     */
    async function checkAuthentication() {
        try {
            const response = await fetch('/api/auth/user');
            const result = await response.json();
            
            if (!result.authenticated) {
                window.location.href = 'login.html';
                return null;
            }
            
            // Check if user has access to menu (ADMIN or STAFF)
            if (result.role !== 'ADMIN' && result.role !== 'STAFF') {
                window.location.href = 'login.html';
                return null;
            }
            
            return result;
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = 'login.html';
            return null;
        }
    }

    /**
     * Logout user
     */
    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
        } catch (error) {
            console.error('Logout error:', error);
        }
        localStorage.removeItem('userRole');
        localStorage.removeItem('username');
        window.location.href = 'login.html';
    }

    // --- Navigation Functions ---
    
    /**
     * Navigate back to admin page (only for ADMIN users)
     */
    function goBackToAdmin() {
        const userRole = localStorage.getItem('userRole');
        if (userRole === 'admin') {
            window.location.href = 'index.html';
        } else {
            alert('Chỉ admin mới có thể truy cập trang quản trị');
        }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Check authentication first
        const user = await checkAuthentication();
        if (!user) return;
        
        // Update UI based on user role
        updateUIForRole(user.role);
        
        // Show the staff order page by default
        document.getElementById('page-staff-order').classList.remove('hidden');
        
        // Initialize the page
        initTableSelector();
        updateOrderType('Dine In', 1);
        renderOrderSummary();
        
        // Load menu data from MySQL database
        await fetchMenuItems();
    });

    /**
     * Update UI elements based on user role
     */
    function updateUIForRole(role) {
        const backToAdminBtn = document.querySelector('button[onclick="goBackToAdmin()"]');
        const logoutBtn = document.getElementById('logout-button');
        
        if (role === 'STAFF') {
            // Hide back to admin button for staff
            if (backToAdminBtn) {
                backToAdminBtn.style.display = 'none';
            }
        }
        
        // Show logout button for all authenticated users
        if (logoutBtn) {
            logoutBtn.classList.remove('hidden');
        }
    }
</script>

</body>
</html>
